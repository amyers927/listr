<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Listr</title>

    <!-- React + ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>

    <!-- React Router DOM v5 (UMD) -->
    <script src="https://unpkg.com/react-router-dom@5/umd/react-router-dom.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        * { box-sizing: border-box; }
        body {
            margin:0;
            padding:0;
            min-height:100vh;
            display:flex;
            justify-content:center;
            align-items:center;
            background:
                radial-gradient(circle at 10% 0%, rgba(255, 0, 128, 0.25) 0, transparent 55%),
                radial-gradient(circle at 90% 100%, rgba(0, 255, 255, 0.18) 0, transparent 50%),
                linear-gradient(135deg, #020617 0%, #050816 50%, #020617 100%);
            color:#e5e7eb;
            font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",Arial,sans-serif;
        }
        #root { width:95%; max-width:1200px; }

        .app-shell { width:100%; }
        .app-shell-inner {
            border-radius:18px;
            padding:24px 24px 28px;
            background:
                radial-gradient(circle at 0 0, rgba(255,255,255,0.06), transparent 55%),
                radial-gradient(circle at 100% 100%, rgba(148,163,184,0.12), transparent 55%),
                rgba(15,23,42,0.9);
            box-shadow:0 22px 60px rgba(0,0,0,0.75);
            border:1px solid rgba(148,163,184,0.35);
        }

        .app-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:20px;
        }
        .app-title {
            letter-spacing:0.16em;
            text-transform:uppercase;
            font-size:11px;
            color:#9ca3af;
        }
        .app-pill {
            font-size:11px;
            padding:4px 10px;
            border-radius:999px;
            border:1px solid rgba(148,163,184,0.7);
            background:rgba(15,23,42,0.85);
            color:#e5e7eb;
        }

        .container {
            display:grid;
            grid-template-columns:1.1fr 1.1fr;
            gap:18px;
        }

        .panel {
            border-radius:14px;
            padding:14px 14px 16px;
            background:radial-gradient(circle at 0 0, rgba(148,163,184,0.16), transparent 55%),
                        rgba(15,23,42,0.88);
            border:1px solid rgba(75,85,99,0.9);
        }
        .panel-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:10px;
        }
        .panel-title { font-size:12px; text-transform:uppercase; letter-spacing:0.16em; color:#9ca3af; }
        .panel-subtitle { font-size:11px; color:#6b7280; }

        .list-body {
            border-radius:10px;
            padding:10px;
            background:radial-gradient(circle at 0 0, rgba(15,23,42,1), rgba(15,23,42,0.8));
            border:1px solid rgba(55,65,81,0.9);
            max-height:420px;
            overflow-y:auto;
        }

        .hint { font-size:10px; letter-spacing:0.12em; text-transform:uppercase; color:#6b7280; margin-bottom:7px; }

        .item, .ranked-item {
            display:flex;
            align-items:center;
            justify-content:space-between;
            border-radius:9px;
            padding:7px 9px;
            margin-bottom:6px;
            font-size:13px;
            background:linear-gradient(135deg, rgba(15,23,42,0.8), rgba(17,24,39,0.9));
            border:1px solid rgba(75,85,99,0.9);
            cursor:grab;
        }

        .ranked-badge {
            width:6px;
            height:6px;
            border-radius:999px;
            border:1px solid rgba(148,163,184,0.8);
        }

        .ranked-list {
            border-radius:10px;
            padding:10px;
            background:radial-gradient(circle at 100% 0, rgba(15,23,42,0.95), rgba(15,23,42,0.8));
            border:1px solid rgba(55,65,81,0.9);
            min-height:120px;
            max-height:420px;
            overflow-y:auto;
        }
        .ranked-list.is-dropping {
            border-color:rgba(94,234,212,0.9);
            box-shadow:0 0 0 1px rgba(45,212,191,0.4);
        }

        .ranked-empty-state {
            font-size:12px;
            color:#6b7280;
            font-style:italic;
        }

        .rank-number { font-size:11px; margin-right:6px; color:#94a3b8; }

        .home-body, .create-body { padding:24px 10px 4px; }
        .home-heading, .create-heading { font-size:20px; margin-bottom:8px; }
        .home-subtitle, .create-subtitle { font-size:13px; color:#9ca3af; margin-bottom:18px; max-width:520px; }

        .primary-button {
            margin-top:8px;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            padding:10px 18px;
            font-size:13px;
            border-radius:999px;
            background:linear-gradient(135deg, rgba(236,72,153,0.1), rgba(52,211,153,0.06));
            border:1px solid rgba(236,72,153,0.7);
            color:#e5e7eb;
            letter-spacing:0.12em;
            text-transform:uppercase;
            cursor:pointer;
        }
        .primary-button:hover {
            box-shadow:0 0 16px rgba(236,72,153,0.45);
            transform:translateY(-1px);
        }
        .primary-button span { margin-left:6px; font-size:16px; }

        .field-label { font-size:11px; text-transform:uppercase; letter-spacing:0.14em; color:#9ca3af; margin-bottom:6px; }

        .textarea {
            width:100%;
            min-height:180px;
            border-radius:12px;
            padding:10px 11px;
            background:rgba(15,23,42,0.9);
            border:1px solid rgba(55,65,81,0.9);
            color:#e5e7eb;
            font-family:inherit;
            font-size:13px;
            resize:vertical;
        }
        .textarea::placeholder { color:#4b5563; }

        .create-actions { margin-top:14px; display:flex; gap:12px; flex-wrap:wrap; }
        .secondary-link { font-size:11px; color:#9ca3af; cursor:pointer; text-decoration:underline; text-decoration-style:dotted; }

        @media (max-width:820px) {
            .container { grid-template-columns:1fr; }
        }
    </style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

/* ==========================================
   GLOBAL DIAGNOSTIC ENTRY LOG
========================================== */
console.log("ðŸ”¥ SCRIPT LOADED â€” Top of file executed");


/* ==========================================
   IMPORTS FROM UMD GLOBALS
========================================== */
const { BrowserRouter, Switch, Route, useHistory, useParams } = window.ReactRouterDOM;
const { useState, useEffect } = React;


/* ==========================================
   HOME SCREEN
========================================== */
function HomeScreen() {
    console.log("ðŸ”¥ HomeScreen rendered");
    const history = useHistory();

    return (
        <div className="app-shell">
            <div className="app-shell-inner">
                <div className="app-header">
                    <div className="app-title">Listr Â· Al-Beiruti Holdings</div>
                    <div className="app-pill">LIST ENGINE Â· v0.1</div>
                </div>

                <div className="home-body">
                    <div className="home-heading">Create a list</div>
                    <div className="home-subtitle">
                        Spin up a ranking grid, drag items into place, and obsess over the order like a reasonable person.
                    </div>

                    <button
                        className="primary-button"
                        onClick={() => {
                            console.log("ðŸ”¥ Navigating to /create");
                            history.push("/create");
                        }}
                    >
                        CREATE A LIST <span>â†—</span>
                    </button>
                </div>
            </div>
        </div>
    );
}


/* ==========================================
   CREATE LIST SCREEN
========================================== */
function CreateListScreen({ setListItems }) {
    console.log("ðŸ”¥ CreateListScreen rendered");
    const history = useHistory();
    const [rawText, setRawText] = useState("");

    const handleStartRanking = async () => {
        console.log("ðŸ”¥ handleStartRanking() called");
        const lines = rawText
            .split("\n")
            .map(line => line.trim())
            .filter(Boolean);

        console.log("ðŸ”¥ Parsed lines:", lines);

        if (!lines.length) {
            alert("Give me at least one item.");
            return;
        }

        setListItems(lines);
        console.log("ðŸ”¥ setListItems() executed");

        let id = null;

        try {
            const res = await fetch("/api/list", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    items: lines,
                    timestamp: Date.now(),
                    userAgent: navigator.userAgent
                })
            });

            console.log("ðŸ”¥ /api/list responded:", res.status);
            const data = await res.json();
            console.log("ðŸ”¥ Backend returned:", data);

            id = data?.id;
        } catch (err) {
            console.error("ðŸ”¥ Error POSTing list:", err);
        }

        if (id) {
            console.log("ðŸ”¥ Navigating to /list/" + id + "/rank");
            history.push(`/list/${id}/rank`);
        } else {
            console.log("ðŸ”¥ No ID returned â€” falling back to /rank");
            history.push("/rank");
        }
    };

    return (
        <div className="app-shell">
            <div className="app-shell-inner">
                <div className="app-header">
                    <div className="app-title">Listr Â· Define your list</div>
                    <div className="app-pill">INPUT STAGE Â· v0.1</div>
                </div>

                <div className="create-body">
                    <div className="create-heading">What are we ranking?</div>
                    <div className="create-subtitle">
                        Add items, one per line.
                    </div>

                    <div className="field-label">Items (one per line)</div>

                    <textarea
                        className="textarea"
                        value={rawText}
                        onChange={e => setRawText(e.target.value)}
                        placeholder="American Analog Set\nTortoise\nThe Cranberries\nHum\nRilo Kiley\n..."
                    />

                    <div className="create-actions">
                        <button className="primary-button" onClick={handleStartRanking}>
                            START RANKING <span>â–¶</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}


/* ==========================================
   RANKING SCREEN â€” dynamic, backend-powered
========================================== */
function RankingScreen() {
    console.log("ðŸ”¥ RankingScreen() CALLED");

    const { listId } = useParams();
    const history = useHistory();

    console.log("ðŸ”¥ Route param listId =", listId);

    const [items, setItems] = useState([]);
    const [rankedItems, setRankedItems] = useState([]);
    const [loading, setLoading] = useState(true);
    const [isDropping, setIsDropping] = useState(false);


    useEffect(() => {
        console.log("ðŸ”¥ RankingScreen useEffect â†’ fetching backend list...");

        async function load() {
            try {
                console.log(`ðŸ”¥ Fetching /api/list/${listId}`);
                const res = await fetch(`/api/list/${listId}`);

                console.log("ðŸ”¥ Backend responded:", res.status);

                const data = await res.json();
                console.log("ðŸ”¥ Loaded backend data:", data);

                setItems(data.items || []);
            } catch (err) {
                console.error("ðŸ”¥ ERROR loading list:", err);
            }
            setLoading(false);
        }

        load();
    }, [listId]);


    if (loading) {
        console.log("ðŸ”¥ RankingScreen loading...");
        return (
            <div className="app-shell">
                <div className="app-shell-inner">
                    <div className="home-heading">Loadingâ€¦</div>
                </div>
            </div>
        );
    }

    console.log("ðŸ”¥ RankingScreen fully mounted â€” items =", items);

    return (
        <div className="app-shell">
            <div className="app-shell-inner">
                <div className="app-header">
                    <div className="app-title">Listr Â· Ranking</div>
                    <div className="app-pill">LIST #{listId}</div>
                </div>

                <div className="container">

                    {/* Available */}
                    <div className="panel">
                        <div className="panel-header">
                            <div>
                                <div className="panel-title">Available Items</div>
                                <div className="panel-subtitle">Drag to rank â†’</div>
                            </div>
                            <div className="secondary-link" onClick={() => history.push("/create")}>
                                new list
                            </div>
                        </div>

                        <div className="list-body">
                            <div className="hint">drag items â†’</div>

                            {items.map(item => (
                                <div
                                    key={item}
                                    className="item"
                                    draggable
                                    onDragStart={(e) => {
                                        e.dataTransfer.setData("drag-type", "available");
                                        e.dataTransfer.setData("item", item);
                                    }}
                                >
                                    <span>{item}</span>
                                    <span className="ranked-badge"></span>
                                </div>
                            ))}

                            {items.length === 0 && (
                                <div className="ranked-empty-state">no remaining items</div>
                            )}
                        </div>
                    </div>

                    {/* Ranked */}
                    <div className="panel">
                        <div className="panel-header">
                            <div>
                                <div className="panel-title">Ranking Stack</div>
                                <div className="panel-subtitle">Reorder items</div>
                            </div>
                        </div>

                        <div
                            className={"ranked-list" + (isDropping ? " is-dropping" : "")}
                            onDragOver={(e) => e.preventDefault()}
                            onDrop={(e) => {
                                const dragType = e.dataTransfer.getData("drag-type");
                                setIsDropping(false);

                                if (dragType === "available") {
                                    const item = e.dataTransfer.getData("item");
                                    setRankedItems([...rankedItems, item]);
                                    setItems(items.filter(i => i !== item));
                                }
                            }}
                            onDragEnter={() => setIsDropping(true)}
                            onDragLeave={() => setIsDropping(false)}
                        >

                            {rankedItems.length === 0 && (
                                <div className="ranked-empty-state">drop items here</div>
                            )}

                            {rankedItems.map((item, i) => (
                                <div
                                    key={item}
                                    className="ranked-item"
                                    draggable
                                    onDragStart={(e) => {
                                        e.dataTransfer.setData("drag-type", "ranked");
                                        e.dataTransfer.setData("sourceIndex", i);
                                    }}
                                >
                                    <span>
                                        <span className="rank-number">#{i + 1}</span>
                                        {item}
                                    </span>
                                    <span className="ranked-badge"></span>
                                </div>
                            ))}
                        </div>
                    </div>

                </div>
            </div>
        </div>
    );
}


/* ==========================================
   APP ROOT WITH DIAGNOSTIC LOGGING
========================================== */
function App() {
    console.log("ðŸ”¥ App() called â€” React Router about to mount");

    const [listItems, setListItems] = React.useState([]);
    console.log("ðŸ”¥ listItems state initialized â†’", listItems);

    return (
        <BrowserRouter basename="/listr">
            {console.log("ðŸ”¥ BrowserRouter rendered")}

            <Switch>
                {console.log("ðŸ”¥ Switch rendered")}

                <Route
                    exact
                    path="/"
                    render={() => {
                        console.log("ðŸ”¥ Route '/' matched");
                        return <HomeScreen />;
                    }}
                />

                <Route
                    path="/create"
                    render={() => {
                        console.log("ðŸ”¥ Route '/create' matched");
                        return <CreateListScreen setListItems={setListItems} />;
                    }}
                />

                <Route
                    path="/list/:listId/rank"
                    render={() => {
                        console.log("ðŸ”¥ Route '/list/:listId/rank' matched");
                        return <RankingScreen />;
                    }}
                />

                <Route
                    path="/rank"
                    render={() => {
                        console.log("ðŸ”¥ Route '/rank' matched");
                        return <RankingScreen initialItems={listItems} />;
                    }}
                />

            </Switch>
        </BrowserRouter>
    );
}


/* ==========================================
   FINAL RENDER
========================================== */
console.log("ðŸ”¥ Calling ReactDOM.render(<App />)");
ReactDOM.render(<App />, document.getElementById("root"));
console.log("ðŸ”¥ ReactDOM.render() finished");

</script>
</body>
</html>
