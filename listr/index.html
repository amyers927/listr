<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listr · Interactive Ranking</title>

    <!-- React + ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>

    <!-- React Router DOM v5 (UMD) -->
    <script src="https://unpkg.com/react-router-dom@5/umd/react-router-dom.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        * { box-sizing: border-box; }
        body {
            margin:0;
            padding:0;
            min-height:100vh;
            display:flex;
            justify-content:center;
            align-items:center;
            background:
                radial-gradient(circle at 10% 0%, rgba(255, 0, 128, 0.25) 0, transparent 55%),
                radial-gradient(circle at 90% 100%, rgba(0, 255, 255, 0.18) 0, transparent 50%),
                linear-gradient(135deg, #020617 0%, #050816 50%, #020617 100%);
            color:#e5e7eb;
            font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",Arial,sans-serif;
        }
        #root { width:95%; max-width:1200px; }

        .app-shell { width:100%; }
        .app-shell-inner {
            border-radius:18px;
            padding:24px;
            background:
                radial-gradient(circle at 0 0, rgba(255,255,255,0.06), transparent 55%),
                radial-gradient(circle at 100% 100%, rgba(148,163,184,0.12), transparent 55%),
                rgba(15,23,42,0.9);
            box-shadow:0 22px 60px rgba(0,0,0,0.75);
            border:1px solid rgba(148,163,184,0.35);
            margin-bottom:90px; /* make room for bottom bar */
        }

        .app-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:20px;
        }
        .app-title { letter-spacing:0.16em; text-transform:uppercase; font-size:11px; color:#9ca3af; }
        .app-pill {
            font-size:11px;
            padding:4px 10px;
            border-radius:999px;
            border:1px solid rgba(148,163,184,0.7);
            background:rgba(15,23,42,0.85);
            color:#e5e7eb;
        }

        .container { display:grid; grid-template-columns:1.1fr 1.1fr; gap:18px; }
        .panel {
            border-radius:14px;
            padding:14px 14px 16px;
            background:radial-gradient(circle at 0 0, rgba(148,163,184,0.16), transparent 55%), rgba(15,23,42,0.88);
            border:1px solid rgba(75,85,99,0.9);
        }

        .list-body, .ranked-list {
            border-radius:10px;
            padding:10px;
            background:rgba(15,23,42,0.9);
            border:1px solid rgba(55,65,81,0.9);
            max-height:420px;
            overflow-y:auto;
        }

        .item, .ranked-item {
            display:flex;
            align-items:center;
            justify-content:space-between;
            border-radius:9px;
            padding:7px 9px;
            margin-bottom:6px;
            font-size:13px;
            background:linear-gradient(135deg, rgba(15,23,42,0.8), rgba(17,24,39,0.9));
            border:1px solid rgba(75,85,99,0.9);
            cursor:grab;
        }

        .bottom-submit-bar {
            position:fixed;
            bottom:0;
            left:0;
            width:100%;
            height:70px;
            background:linear-gradient(135deg, rgba(6,182,212,0.35), rgba(74,222,128,0.35));
            backdrop-filter:blur(6px);
            border-top:1px solid rgba(255,255,255,0.12);
            display:flex;
            justify-content:center;
            align-items:center;
            z-index:9999;
        }

        .submit-button {
            width:90%;
            max-width:420px;
            padding:16px 0;
            border-radius:999px;
            font-size:16px;
            text-transform:uppercase;
            letter-spacing:0.12em;
            border:none;
            cursor:pointer;
            transition:200ms ease;
            background:linear-gradient(135deg, #06b6d4, #4ade80);
            color:#fff;
            box-shadow:0 0 22px rgba(6,182,212,0.65);
        }

        .submit-button.disabled {
            filter:grayscale(80%);
            opacity:0.55;
        }

        @media(max-width:820px){ .container { grid-template-columns:1fr; } }
    </style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { BrowserRouter, Switch, Route, useHistory, useParams } = window.ReactRouterDOM;
const { useState, useEffect } = React;

/* ---------------- HOME ---------------- */
function HomeScreen() {
    const history = useHistory();
    return (
        <div className="app-shell">
            <div className="app-shell-inner">
                <div className="app-header">
                    <div className="app-title">Listr · Al-Beiruti Holdings</div>
                    <div className="app-pill">LIST ENGINE · v0.1</div>
                </div>

                <div className="home-body">
                    <h2>Create a list</h2>
                    <p>Spin up a ranking grid, drag items, obsess over the order.</p>
                    <button className="submit-button"
                        onClick={() => history.push("/create")}
                        style={{maxWidth:"200px"}}>
                        Create a List
                    </button>
                </div>
            </div>
        </div>
    );
}

/* ---------------- CREATE ---------------- */
function CreateListScreen({ setListItems }) {
    const history = useHistory();
    const [rawText, setRawText] = useState("");

    const handleStartRanking = async () => {
        const lines = rawText.split("\n").map(x => x.trim()).filter(Boolean);

        if (!lines.length) return alert("Add at least one item");

        setListItems(lines);

        let id = null;
        try {
            const res = await fetch("/api/list", {
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({ items: lines })
            });
            const data = await res.json();
            id = data?.id;
        } catch (err) {
            console.error(err);
        }

        if (id) history.push(`/list/${id}/rank`);
        else history.push("/rank");
    };

    return (
    <div className="app-shell">
      <div className="app-shell-inner">
        <div className="app-header">
          <div className="app-title">Define your list</div>
          <div className="app-pill">INPUT STAGE</div>
        </div>

        <textarea className="textarea"
            value={rawText}
            onChange={e => setRawText(e.target.value)}
            placeholder="One item per line" />

        <button className="submit-button" style={{maxWidth:"250px"}}
            onClick={handleStartRanking}>Start Ranking</button>
      </div>
    </div>);
}

/* ---------------- RANKING ---------------- */
function RankingScreen() {
    const { listId } = useParams();
    const history = useHistory();
    const [items, setItems] = useState([]);
    const [rankedItems, setRankedItems] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        (async () => {
            try {
                const res = await fetch(`/api/list/${listId}`);
                const data = await res.json();
                setItems(data.items || []);
            } catch (err) {
                console.error(err);
            }
            setLoading(false);
        })();
    }, [listId]);

    const allRanked = items.length === 0 && rankedItems.length > 0;

    const handleSubmitRanking = async () => {
        if (!allRanked) return alert("Rank all items first!");

        const res = await fetch(`/api/list/${listId}/submit`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({ ranking: rankedItems })
        });

        const data = await res.json();
        history.push(`/list/${listId}/results`);
    };

    const handleDragStartAvailable = (e, item) => {
        e.dataTransfer.setData("x", item);
    };
    const handleDropOnRank = (e) => {
        const item = e.dataTransfer.getData("x");
        if (!item) return;
        if (rankedItems.includes(item)) return;
        setRankedItems([...rankedItems, item]);
        setItems(items.filter(x => x !== item));
    };

    if (loading) {
        return <div className="app-shell"><div className="app-shell-inner">Loading…</div></div>;
    }

    return (
    <>
    <div className="app-shell">
      <div className="app-shell-inner">
        <div className="app-header">
          <div className="app-title">Ranking</div>
          <div className="app-pill">LIST #{listId}</div>
        </div>

        <div className="container">
          <div className="panel">
            <h4>Available Items</h4>
            <div className="list-body">
              {items.map(item => (
                <div key={item} className="item" draggable
                    onDragStart={(e)=>handleDragStartAvailable(e,item)}>
                    {item}
                </div>
              ))}
              {items.length === 0 && <i>All items ranked →</i>}
            </div>
          </div>

          <div className="panel">
            <h4>Ranking</h4>
            <div className="ranked-list"
                onDragOver={e=>e.preventDefault()}
                onDrop={handleDropOnRank}>

              {rankedItems.map((item, i) => (
                <div key={item} className="ranked-item">
                  #{i+1} — {item}
                </div>
              ))}

              {rankedItems.length === 0 && <i>Drag items here to rank</i>}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div className="bottom-submit-bar">
        <button
            className={"submit-button" + (allRanked ? "" : " disabled")}
            onClick={handleSubmitRanking}>
            Submit Ranking →
        </button>
    </div>
    </>
    );
}

/* ---------------- RESULTS ---------------- */
function ResultsScreen() {
    const { listId } = useParams();
    const [results, setResults] = useState(null);

    useEffect(() => {
        (async () => {
            try {
                const res = await fetch(`/api/list/${listId}/results`);
                const data = await res.json();
                setResults(data);
            } catch (err) {
                console.error(err);
            }
        })();
    }, [listId]);

    if (!results) {
        return <div className="app-shell"><div className="app-shell-inner">Loading…</div></div>;
    }

    return (
        <div className="app-shell">
            <div className="app-shell-inner">
                <div className="app-header">
                    <div className="app-title">Results</div>
                    <div className="app-pill">LIST #{listId}</div>
                </div>

                <h2>Final Ranking</h2>

                {results.finalRanking.map((item, i)=>(
                    <div key={item} className="item">
                        <strong>#{i+1}</strong> — {item}
                    </div>
                ))}

                <h3 style={{marginTop:"26px"}}>Submissions: {results.submissionCount}</h3>
            </div>
        </div>
    );
}

/* ---------------- APP ROUTER ---------------- */
function App() {
    const [listItems, setListItems] = useState([]);

    return (
        <BrowserRouter basename="/listr">
          <Switch>
            <Route exact path="/" component={HomeScreen} />
            <Route path="/create" render={() => (
                <CreateListScreen setListItems={setListItems} />
            )} />
            <Route path="/list/:listId/rank" component={RankingScreen} />
            <Route path="/list/:listId/results" component={ResultsScreen} />

            <Route path="/rank" render={() => (
                <RankingScreen initialItems={listItems} />
            )} />
          </Switch>
        </BrowserRouter>
    );
}

ReactDOM.render(<App />, document.getElementById("root"));

</script>
</body>
</html>
