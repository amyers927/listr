<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Listr ¬∑ Interactive Ranking</title>

    <!-- React + ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>

    <!-- React Router DOM v5 -->
    <script src="https://unpkg.com/react-router-dom@5/umd/react-router-dom.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Global reset + base look */
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background:
                radial-gradient(circle at 10% 0%, rgba(255, 0, 128, 0.22), transparent 55%),
                radial-gradient(circle at 90% 100%, rgba(0, 255, 255, 0.18), transparent 50%),
                linear-gradient(135deg, #020617 0%, #050816 50%, #020617 100%);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", Arial, sans-serif;
            color: #e5e7eb;
            padding-bottom: 120px; /* space for fixed submit bar */
        }

        #root {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
        }

        /* App shell */
        .app-shell {
            width: 100%;
        }

        .app-shell-inner {
            border-radius: 18px;
            padding: 24px 24px 28px;
            background:
                radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.06), transparent 55%),
                radial-gradient(circle at 100% 100%, rgba(148, 163, 184, 0.12), transparent 55%),
                rgba(15, 23, 42, 0.88);
            border: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 0 22px 60px rgba(0, 0, 0, 0.75);
        }

        /* Header */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .app-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: #9ca3af;
        }

        .app-pill {
            padding: 4px 10px;
            font-size: 11px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: rgba(15, 23, 42, 0.85);
            color: #e5e7eb;
        }

        /* Panels layout */
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
        }

        @media (max-width: 820px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        /* Panels */
        .panel {
            border-radius: 14px;
            padding: 16px;
            background:
                radial-gradient(circle at 0 0, rgba(148, 163, 184, 0.16), transparent 55%),
                rgba(15, 23, 42, 0.88);
            border: 1px solid rgba(75, 85, 99, 0.7);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .panel-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: #9ca3af;
        }

        .panel-subtitle {
            font-size: 11px;
            color: #6b7280;
        }

        /* List bodies */
        .list-body,
        .ranked-list {
            border-radius: 10px;
            padding: 10px;
            background:
                radial-gradient(circle at 0 0, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.8));
            border: 1px solid rgba(55, 65, 81, 0.9);
            max-height: 420px;
            overflow-y: auto;
        }

        .hint {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .item,
        .ranked-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 7px 9px;
            margin-bottom: 6px;
            border-radius: 9px;
            font-size: 13px;
            background: linear-gradient(
                135deg,
                rgba(15, 23, 42, 0.85),
                rgba(17, 24, 39, 0.9)
            );
            border: 1px solid rgba(75, 85, 99, 0.8);
            cursor: grab;
        }

        .rank-number {
            font-size: 11px;
            margin-right: 8px;
            color: #94a3b8;
        }

        /* Empty state */
        .ranked-empty-state {
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
        }

        /* Grey primary buttons with teal active glow */
        .primary-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 18px;
            font-size: 13px;
            border-radius: 999px;
            background: #3b3b3b;
            border: 1px solid #565656;
            color: #e5e7eb;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            cursor: pointer;
            transition: 0.18s ease;
        }

        .primary-button:hover {
            background: #4a4a4a;
        }

        .primary-button:active {
            box-shadow: 0 0 18px rgba(45, 212, 191, 0.7);
            border-color: #2dd4bf;
            color: #2dd4bf;
        }

        /* Fixed bottom submit bar */
        .submit-bar {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            padding: 12px 22px;
            background: rgba(10, 15, 25, 0.72);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(148, 163, 184, 0.25);
            display: flex;
            justify-content: center;
            z-index: 9999;
        }

        .submit-button {
            padding: 14px 26px;
            font-size: 14px;
            border-radius: 999px;
            background: #3a3a3a;
            border: 1px solid #5a5a5a;
            color: #e5e7eb;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            cursor: pointer;
            transition: 0.2s ease;
        }

        .submit-button:hover {
            background: #4a4a4a;
        }

        .submit-button:active {
            box-shadow: 0 0 20px rgba(45, 212, 191, 0.75);
            border-color: #2dd4bf;
            color: #2dd4bf;
        }
    </style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
/* -----------------------------------
   IMPORTS & HOOK ALIASES
----------------------------------- */
const {
    BrowserRouter,
    Switch,
    Route,
    useHistory,
    useParams
} = window.ReactRouterDOM;

const {
    useState,
    useEffect
} = React;


/* -----------------------------------
   HOME SCREEN  (/listr)
----------------------------------- */
function HomeScreen() {
    const history = useHistory();

    return (
        <div className="app-shell">
            <div className="app-shell-inner">
                <div className="app-header">
                    <div className="app-title">Listr ¬∑ Al-Beiruti Holdings</div>
                    <div className="app-pill">LIST ENGINE ¬∑ v0.1</div>
                </div>

                <div className="home-body">
                    <div className="home-heading">Create a list</div>
                    <div className="home-subtitle">
                        Spin up a ranking grid, drag items around, and obsess over
                        the order like a totally normal human being.
                    </div>

                    <button
                        className="primary-button"
                        onClick={() => history.push("/create")}
                    >
                        CREATE A LIST <span>‚Üó</span>
                    </button>
                </div>
            </div>
        </div>
    );
}


/* -----------------------------------
   CREATE SCREEN  (/create)
----------------------------------- */
function CreateListScreen({ setListItems }) {
    const history = useHistory();
    const [rawText, setRawText] = useState("");

    async function handleStartRanking() {
        const lines = rawText
            .split("\n")
            .map(x => x.trim())
            .filter(Boolean);

        if (!lines.length) {
            alert("Give me at least one item, king.");
            return;
        }

        // Local copy (fallback mode)
        setListItems(lines);

        let id = null;

        try {
            console.log("üî• POST ‚Üí /api/list");
            const res = await fetch("/api/list", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    items: lines,
                    timestamp: Date.now(),
                    userAgent: navigator.userAgent
                })
            });

            const data = await res.json();
            console.log("üî• backend responded:", data);
            id = data?.id || null;
        } catch (err) {
            console.error("‚ùå Error submitting list:", err);
        }

        // Prefer the backend ID
        if (id) {
            history.push(`/list/${id}/rank`);
        } else {
            history.push("/rank"); // fallback local mode
        }
    }

    function handleClear() {
        setRawText("");
    }

    return (
        <div className="app-shell">
            <div className="app-shell-inner">

                <div className="app-header">
                    <div className="app-title">Listr ¬∑ Define your list</div>
                    <div className="app-pill">INPUT STAGE ¬∑ v0.1</div>
                </div>

                <div className="create-body">
                    <div className="create-heading">What are we ranking?</div>

                    <div className="create-subtitle">
                        Add one item per line ‚Äî bands, movies, restaurants,
                        dog names, intrusive thoughts, whatever.
                    </div>

                    <div className="field-label">Items (one per line)</div>

                    <textarea
                        className="textarea"
                        value={rawText}
                        onChange={e => setRawText(e.target.value)}
                        placeholder={`Example:
American Analog Set
Tortoise
The Cranberries
Hum
Rilo Kiley
...`}
                    />

                    <div className="create-actions">
                        <button
                            className="primary-button"
                            onClick={handleStartRanking}
                        >
                            START RANKING <span>‚ñ∂</span>
                        </button>

                        <div className="secondary-link" onClick={handleClear}>
                            clear all
                        </div>
                    </div>

                </div>
            </div>
        </div>
    );
}
/* -----------------------------------
   RANKING SCREEN  (/list/:listId/rank)
----------------------------------- */

function RankingScreen() {
    const { listId } = useParams();
    const history = useHistory();

    const [items, setItems] = useState([]);
    const [rankedItems, setRankedItems] = useState([]);
    const [loading, setLoading] = useState(true);
    const [isDroppingOnRanked, setIsDroppingOnRanked] = useState(false);

    /* -----------------------------------
       LOAD LIST FROM BACKEND
    ----------------------------------- */
    useEffect(() => {
        async function load() {
            try {
                console.log("üî• Fetching list from backend:", listId);
                const res = await fetch(`/api/list/${listId}`);
                const data = await res.json();
                console.log("üî• Backend list loaded:", data);

                setItems(data.items || []);
            } catch (err) {
                console.error("‚ùå Failed loading list:", err);
            }

            setLoading(false);
        }

        load();
    }, [listId]);


    /* -----------------------------------
       DRAG LOGIC
    ----------------------------------- */
    function handleDragStartAvailable(e, item) {
        e.dataTransfer.setData("drag-type", "available");
        e.dataTransfer.setData("item", item);
    }

    function handleDragStartRanked(e, index) {
        e.dataTransfer.setData("drag-type", "ranked");
        e.dataTransfer.setData("sourceIndex", String(index));
    }

    function handleDragOver(e) {
        e.preventDefault();
    }

    function handleDropOnRankedContainer(e) {
        e.preventDefault();
        setIsDroppingOnRanked(false);

        const type = e.dataTransfer.getData("drag-type");

        if (type === "available") {
            const item = e.dataTransfer.getData("item");
            if (item && !rankedItems.includes(item)) {
                setRankedItems([...rankedItems, item]);
                setItems(items.filter(i => i !== item));
            }
        } else if (type === "ranked") {
            const sourceIndex = parseInt(e.dataTransfer.getData("sourceIndex"), 10);

            if (!isNaN(sourceIndex)) {
                const updated = [...rankedItems];
                const [moved] = updated.splice(sourceIndex, 1);
                updated.push(moved);
                setRankedItems(updated);
            }
        }
    }

    function handleDropOnRankedItem(e, targetIndex) {
        e.preventDefault();
        e.stopPropagation();
        setIsDroppingOnRanked(false);

        const type = e.dataTransfer.getData("drag-type");

        if (type === "available") {
            const item = e.dataTransfer.getData("item");
            if (item && !rankedItems.includes(item)) {
                const updated = [...rankedItems];
                updated.splice(targetIndex, 0, item);
                setRankedItems(updated);
                setItems(items.filter(i => i !== item));
            }
        } else if (type === "ranked") {
            const sourceIndex = parseInt(e.dataTransfer.getData("sourceIndex"), 10);
            if (sourceIndex === targetIndex) return;

            const updated = [...rankedItems];
            const [moved] = updated.splice(sourceIndex, 1);

            const adjustedIndex = sourceIndex < targetIndex
                ? targetIndex - 1
                : targetIndex;

            updated.splice(adjustedIndex, 0, moved);

            setRankedItems(updated);
        }
    }


    /* -----------------------------------
       SUBMIT RANKING
    ----------------------------------- */
    async function handleSubmit() {
        if (rankedItems.length !== items.length + rankedItems.length) {
            alert("Rank all items before submitting.");
            return;
        }

        const fullRanking = [...rankedItems, ...items];

        try {
            console.log("üî• POST ‚Üí /api/list/" + listId + "/submit");

            const res = await fetch(`/api/list/${listId}/submit`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    ranking: fullRanking,
                    timestamp: Date.now(),
                    userAgent: navigator.userAgent
                })
            });

            const data = await res.json();
            console.log("üî• Submit response:", data);

            history.push(`/list/${listId}/results`);
        } catch (err) {
            console.error("‚ùå Error submitting ranking:", err);
        }
    }


    /* -----------------------------------
       LOADING + EMPTY STATES
    ----------------------------------- */
    if (loading) {
        return (
            <div className="app-shell">
                <div className="app-shell-inner">
                    <div className="home-heading">Loading list‚Ä¶</div>
                </div>
            </div>
        );
    }

    if (!items.length && !rankedItems.length) {
        return (
            <div className="app-shell">
                <div className="app-shell-inner">
                    <div className="home-heading">This list does not exist.</div>
                </div>
            </div>
        );
    }


    /* -----------------------------------
       RENDER RANKING UI
    ----------------------------------- */
    return (
        <div className="app-shell">
            <div className="app-shell-inner">

                <div className="app-header">
                    <div className="app-title">Listr ¬∑ Rank Items</div>
                    <div className="app-pill">LIST #{listId}</div>
                </div>

                <div className="container">

                    {/* LEFT: AVAILABLE ITEMS */}
                    <div className="panel">
                        <div className="panel-header">
                            <div>
                                <div className="panel-title">Available Items</div>
                                <div className="panel-subtitle">Drag to the right ‚Üí</div>
                            </div>

                            <div
                                className="secondary-link"
                                onClick={() => history.push("/create")}
                            >
                                New list
                            </div>
                        </div>

                        <div className="list-body">
                            <div className="hint">drag items to rank them</div>

                            {items.map(item => (
                                <div
                                    key={item}
                                    className="item"
                                    draggable
                                    onDragStart={e => handleDragStartAvailable(e, item)}
                                >
                                    <span>{item}</span>
                                    <span className="ranked-badge"></span>
                                </div>
                            ))}

                            {items.length === 0 && (
                                <div className="ranked-empty-state">
                                    all items drafted ‚Üí reorder on the right
                                </div>
                            )}
                        </div>
                    </div>


                    {/* RIGHT: RANKED STACK */}
                    <div className="panel">
                        <div className="panel-header">
                            <div>
                                <div className="panel-title">Ranking Stack</div>
                                <div className="panel-subtitle">Reorder items</div>
                            </div>
                        </div>

                        <div
                            className={
                                "ranked-list" +
                                (isDroppingOnRanked ? " is-dropping" : "")
                            }
                            onDragOver={handleDragOver}
                            onDrop={handleDropOnRankedContainer}
                            onDragEnter={() => setIsDroppingOnRanked(true)}
                            onDragLeave={() => setIsDroppingOnRanked(false)}
                        >
                            {rankedItems.length === 0 && (
                                <div className="ranked-empty-state">
                                    drop items here to begin ranking
                                </div>
                            )}

                            {rankedItems.map((item, index) => (
                                <div
                                    key={item}
                                    className="ranked-item"
                                    draggable
                                    onDragStart={e => handleDragStartRanked(e, index)}
                                    onDragOver={handleDragOver}
                                    onDrop={e => handleDropOnRankedItem(e, index)}
                                >
                                    <span>
                                        <span className="rank-number">#{index + 1}</span>
                                        {item}
                                    </span>
                                    <span className="ranked-badge"></span>
                                </div>
                            ))}
                        </div>
                    </div>

                </div>

            </div>

            {/* FIXED SUBMIT BAR */}
            <div className="submit-bar">
                <button className="submit-button" onClick={handleSubmit}>
                    SUBMIT RANKING
                </button>
            </div>
        </div>
    );
}

                    </Route>

            </Switch>
        </BrowserRouter>
    );
}

/* üî• Render the whole SPA */
console.log("üî• Calling ReactDOM.render(<App />)");
ReactDOM.render(<App />, document.getElementById("root"));

</script>
</body>
</html>
