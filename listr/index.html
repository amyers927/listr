<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Listr · Interactive Ranking</title>

    <!-- React 17 + ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>

    <!-- React Router 5 (UMD) -->
    <script src="https://unpkg.com/react-router-dom@5/umd/react-router-dom.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        * { box-sizing:border-box; }
        body {
            margin:0;
            padding:0;
            min-height:100vh;
            display:flex;
            justify-content:center;
            align-items:center;
            background:
                radial-gradient(circle at 10% 0%, rgba(255, 0, 128, 0.25) 0, transparent 55%),
                radial-gradient(circle at 90% 100%, rgba(0, 255, 255, 0.18) 0, transparent 50%),
                linear-gradient(135deg, #020617 0%, #050816 50%, #020617 100%);
            color:#e5e7eb;
            font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",Arial,sans-serif;
        }
        #root { width:95%; max-width:1200px; }

        .app-shell-inner {
            border-radius:18px;
            padding:24px 24px 28px;
            background:
                radial-gradient(circle at 0 0, rgba(255,255,255,0.06), transparent 55%),
                radial-gradient(circle at 100% 100%, rgba(148,163,184,0.12), transparent 55%),
                rgba(15,23,42,0.9);
            box-shadow:0 22px 60px rgba(0,0,0,0.75);
            border:1px solid rgba(148,163,184,0.35);
        }

        .primary-button {
            margin-top:8px;
            padding:10px 18px;
            font-size:13px;
            border-radius:999px;
            background:linear-gradient(135deg, rgba(236,72,153,0.1), rgba(52,211,153,0.06));
            border:1px solid rgba(236,72,153,0.7);
            color:#e5e7eb;
            text-transform:uppercase;
            letter-spacing:0.12em;
            cursor:pointer;
            transition:160ms ease;
        }
        .primary-button:hover {
            box-shadow:0 0 16px rgba(236,72,153,0.45);
            transform:translateY(-1px);
        }

        .item, .ranked-item {
            background:linear-gradient(135deg, rgba(15,23,42,0.8), rgba(17,24,39,0.9));
            border:1px solid rgba(75,85,99,0.9);
            border-radius:9px;
            padding:7px 9px;
            margin-bottom:6px;
            cursor:grab;
            display:flex;
            justify-content:space-between;
        }

        .ranked-list {
            min-height:140px;
            border:1px solid rgba(55,65,81,0.9);
            border-radius:10px;
            padding:10px;
        }
    </style>
</head>

<body>
    <div id="root"></div>

<script type="text/babel">

/****************************************************
    Imports
*****************************************************/
const {
  BrowserRouter,
  Switch,
  Route,
  useHistory,
  useParams
} = window.ReactRouterDOM;

const { useState, useEffect } = React;


/****************************************************
    HOME SCREEN
*****************************************************/
function HomeScreen() {
  const history = useHistory();
  return (
    <div className="app-shell-inner">
      <h1>Listr</h1>
      <p>Create a ranked list. Drag items. Obsess.</p>
      <button className="primary-button" onClick={() => history.push("/create")}>
        Create List
      </button>
    </div>
  );
}


/****************************************************
    CREATE LIST SCREEN
*****************************************************/
function CreateListScreen({ setListItems }) {
  const history = useHistory();
  const [rawText, setRawText] = useState("");

  const handleStartRanking = async () => {
    const lines = rawText
      .split("\n")
      .map(x => x.trim())
      .filter(Boolean);

    if (!lines.length) return alert("Need at least one item.");

    // Local fallback
    setListItems(lines);

    // Try backend log
    let id = null;
    try {
      const res = await fetch("/api/list", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          items: lines,
          timestamp: Date.now(),
          ua: navigator.userAgent
        })
      });
      const data = await res.json();
      id = data?.id;
    } catch (err) {
      console.warn("KV logging failed:", err);
    }

    if (id) history.push(`/list/${id}/rank`);
    else history.push("/rank");
  };

  return (
    <div className="app-shell-inner">
      <h1>Create List</h1>
      <textarea
        style={{width:"100%", minHeight:"200px"}}
        placeholder="One item per line"
        value={rawText}
        onChange={e=>setRawText(e.target.value)}
      />
      <button className="primary-button" onClick={handleStartRanking}>
        Start Ranking
      </button>
    </div>
  );
}


/****************************************************
    RANKING SCREEN
*****************************************************/
function RankingScreen() {
  const { listId } = useParams();
  const history = useHistory();

  const [items, setItems] = useState([]);
  const [ranked, setRanked] = useState([]);
  const [loading, setLoading] = useState(true);

  /* Load initial data from KV */
  useEffect(() => {
    async function load() {
      try {
        const res = await fetch(`/api/list/${listId}`);
        const data = await res.json();
        setItems(data.items || []);
      } catch (e) {
        console.error("Load failed:", e);
      }
      setLoading(false);
    }
    load();
  }, [listId]);

  if (loading) return <div className="app-shell-inner">Loading…</div>;

  const handleDragStartAvailable = (e, item) => {
    e.dataTransfer.setData("type", "avail");
    e.dataTransfer.setData("val", item);
  };

  const handleDragStartRanked = (e, index) => {
    e.dataTransfer.setData("type", "ranked");
    e.dataTransfer.setData("index", index);
  };

  const handleDropOnRanked = (e) => {
    e.preventDefault();
    const type = e.dataTransfer.getData("type");
    if (type === "avail") {
      const item = e.dataTransfer.getData("val");
      if (!ranked.includes(item)) {
        setRanked([...ranked, item]);
        setItems(items.filter(i => i !== item));
      }
    }
  };

  const handleDropOnRankedItem = (e, target) => {
    e.preventDefault();
    const type = e.dataTransfer.getData("type");
    if (type === "avail") {
      const item = e.dataTransfer.getData("val");
      if (!ranked.includes(item)) {
        const copy = [...ranked];
        copy.splice(target, 0, item);
        setRanked(copy);
        setItems(items.filter(i => i !== item));
      }
    }
  };

  /*************** SUBMISSION ***************/
  const handleSubmitRanking = async () => {
    try {
      const res = await fetch(`/api/list/${listId}/submit`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          ranked,
          timestamp: Date.now(),
          ua: navigator.userAgent
        })
      });
      const data = await res.json();
      console.log("Submit response:", data);
    } catch (err) {
      console.error("Submit failed:", err);
    }
    // Always navigate
    history.push(`/list/${listId}/results`);
  };

  return (
    <div className="app-shell-inner">
      <h2>Ranking: {listId}</h2>

      <div style={{display:"flex", gap:"20px"}}>

        {/* AVAILABLE */}
        <div style={{flex:1}}>
          <h3>Available</h3>
          {items.map(item => (
            <div
              key={item}
              draggable
              className="item"
              onDragStart={e=>handleDragStartAvailable(e, item)}
            >
              {item}
            </div>
          ))}
        </div>

        {/* RANKED */}
        <div style={{flex:1}}>
          <h3>Your Ranking</h3>
          <div
            className="ranked-list"
            onDragOver={e=>e.preventDefault()}
            onDrop={handleDropOnRanked}
          >
            {ranked.length === 0 && (
              <div style={{opacity:0.5}}>Drag items here</div>
            )}

            {ranked.map((item, index) => (
              <div
                key={item}
                className="ranked-item"
                draggable
                onDragStart={e => handleDragStartRanked(e, index)}
                onDragOver={e => e.preventDefault()}
                onDrop={e => handleDropOnRankedItem(e, index)}
              >
                #{index+1} — {item}
              </div>
            ))}
          </div>

          <button
            className="primary-button"
            style={{marginTop:"15px"}}
            onClick={handleSubmitRanking}
          >
            Submit Ranking
          </button>
        </div>

      </div>
    </div>
  );
}


/****************************************************
    RESULTS SCREEN
*****************************************************/
function ResultsScreen() {
  const { listId } = useParams();
  const [results, setResults] = useState(null);

  useEffect(() => {
    async function load() {
      const res = await fetch(`/api/list/${listId}/results`);
      const data = await res.json();
      setResults(data.final);
    }
    load();
  }, [listId]);

  if (!results)
    return <div className="app-shell-inner">Loading results…</div>;

  return (
    <div className="app-shell-inner">
      <h2>Final Results</h2>

      {results.map((row, i) => (
        <div key={row.item} className="item">
          #{i+1} — {row.item}
          <span style={{opacity:0.6}}>Score: {row.score}</span>
        </div>
      ))}
    </div>
  );
}


/****************************************************
    APP ROUTER
*****************************************************/
function App() {
  const [listItems, setListItems] = useState([]);

  return (
    <BrowserRouter basename="/listr">
      <Switch>

        <Route exact path="/" component={HomeScreen} />

        <Route
          path="/create"
          render={() => <CreateListScreen setListItems={setListItems} />}
        />

        <Route
          path="/list/:listId/rank"
          component={RankingScreen}
        />

        <Route
          path="/list/:listId/results"
          component={ResultsScreen}
        />

        {/* Local fallback */}
        <Route
          path="/rank"
          render={() => (
            <RankingScreen initialItems={listItems} />
          )}
        />

      </Switch>
    </BrowserRouter>
  );
}

ReactDOM.render(<App />, document.getElementById("root"));

</script>

</body>
</html>
