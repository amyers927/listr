<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Listr Â· Interactive Ranking</title>

    <!-- React + ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>

    <!-- React Router DOM v5 (UMD) -->
    <script src="https://unpkg.com/react-router-dom@5/umd/react-router-dom.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        * { box-sizing: border-box; }
        body {
            margin:0; padding:0; min-height:100vh;
            display:flex; justify-content:center; align-items:center;
            background:
                radial-gradient(circle at 10% 0%, rgba(255,0,128,0.25), transparent 55%),
                radial-gradient(circle at 90% 100%, rgba(0,255,255,0.18), transparent 50%),
                linear-gradient(135deg, #020617, #050816, #020617);
            color:#e5e7eb;
            font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",Arial,sans-serif;
        }
        #root { width:95%; max-width:1200px; }

        .app-shell { width:100%; }
        .app-shell-inner {
            border-radius:18px; padding:24px 24px 28px;
            background:
                radial-gradient(circle at 0 0, rgba(255,255,255,0.06), transparent 55%),
                radial-gradient(circle at 100% 100%, rgba(148,163,184,0.12), transparent 55%),
                rgba(15,23,42,0.9);
            box-shadow:0 22px 60px rgba(0,0,0,0.75);
            border:1px solid rgba(148,163,184,0.35);
        }

        .app-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .app-title { letter-spacing:0.16em; text-transform:uppercase; font-size:11px; color:#9ca3af; }
        .app-pill { font-size:11px; padding:4px 10px; border-radius:999px;
            border:1px solid rgba(148,163,184,0.7);
            background:rgba(15,23,42,0.85);
        }

        .container { display:grid; grid-template-columns:1fr 1fr; gap:18px; }

        .panel {
            border-radius:14px; padding:14px;
            background:radial-gradient(circle at 0 0, rgba(148,163,184,0.16), transparent 55%),
                       rgba(15,23,42,0.88);
            border:1px solid rgba(75,85,99,0.9);
        }

        .panel-header { display:flex; justify-content:space-between; margin-bottom:10px; }
        .panel-title { font-size:12px; text-transform:uppercase; letter-spacing:0.16em; color:#9ca3af; }
        .panel-subtitle { font-size:11px; color:#6b7280; }

        .list-body {
            border-radius:10px; padding:10px;
            background:radial-gradient(circle at 0 0, rgba(15,23,42,1), rgba(15,23,42,0.8));
            border:1px solid rgba(55,65,81,0.9);
            max-height:420px; overflow-y:auto;
        }

        .item, .ranked-item {
            display:flex; justify-content:space-between; align-items:center;
            border-radius:9px; padding:7px 9px; margin-bottom:6px; font-size:13px;
            background:linear-gradient(135deg, rgba(15,23,42,0.8), rgba(17,24,39,0.9));
            border:1px solid rgba(75,85,99,0.9); cursor:grab;
        }

        .ranked-list {
            border-radius:10px; padding:10px;
            background:radial-gradient(circle at 100% 0, rgba(15,23,42,0.95), rgba(15,23,42,0.8));
            border:1px solid rgba(55,65,81,0.9);
            min-height:180px; max-height:420px; overflow-y:auto;
        }

        .ranked-number { font-size:11px; margin-right:6px; color:#94a3b8; }

        .primary-button {
            margin-top:12px;
            display:inline-flex; align-items:center; justify-content:center;
            padding:10px 18px; border-radius:999px;
            font-size:13px; text-transform:uppercase; letter-spacing:0.12em;
            background:linear-gradient(135deg, rgba(236,72,153,0.1), rgba(52,211,153,0.06));
            border:1px solid rgba(236,72,153,0.7);
            cursor:pointer; transition:160ms ease;
        }

        .primary-button:hover { transform:translateY(-1px); box-shadow:0 0 16px rgba(236,72,153,0.45); }

        .secondary-link { font-size:11px; color:#9ca3af; cursor:pointer; text-decoration:underline dotted; }

        @media (max-width:820px) {
            .container { grid-template-columns:1fr; }
        }
    </style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { BrowserRouter, Switch, Route, useHistory, useParams } = window.ReactRouterDOM;
const { useState, useEffect } = React;

/* ------------------------------------------------------------------------------------
   HOME
------------------------------------------------------------------------------------ */
function HomeScreen() {
    const history = useHistory();
    return (
        <div className="app-shell">
            <div className="app-shell-inner">

                <div className="app-header">
                    <div className="app-title">Listr Â· Al-Beiruti Holdings</div>
                    <div className="app-pill">LIST ENGINE Â· v0.1</div>
                </div>

                <div className="home-body">
                    <div className="home-heading">Create a list</div>
                    <div className="home-subtitle">Drag, obsess, rearrange. Embrace your madness.</div>

                    <button className="primary-button" onClick={() => history.push("/create")}>
                        Create a List <span>â†—</span>
                    </button>
                </div>

            </div>
        </div>
    );
}

/* ------------------------------------------------------------------------------------
   CREATE LIST
------------------------------------------------------------------------------------ */
function CreateListScreen({ setListItems }) {
    const history = useHistory();
    const [rawText, setRawText] = useState("");

    const handleStartRanking = async () => {
        const lines = rawText.split("\n").map(x=>x.trim()).filter(Boolean);

        if (!lines.length) return alert("Give me at least one item, king.");

        setListItems(lines);

        let id = null;
        try {
            const res = await fetch("/api/list", {
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({
                    items:lines,
                    timestamp:Date.now(),
                    userAgent:navigator.userAgent
                })
            });

            const data = await res.json();
            id = data?.id;
        } catch (err) {
            console.error("POST /api/list failed", err);
        }

        if (id) history.push(`/list/${id}/rank`);
        else history.push("/rank");
    };

    return (
        <div className="app-shell">
            <div className="app-shell-inner">

                <div className="app-header">
                    <div className="app-title">Listr Â· Define List</div>
                    <div className="app-pill">INPUT</div>
                </div>

                <div className="create-body">
                    <div className="create-heading">What are we ranking?</div>

                    <textarea
                        className="textarea"
                        value={rawText}
                        onChange={e => setRawText(e.target.value)}
                        placeholder="One item per line..."
                    />

                    <div className="create-actions">
                        <button className="primary-button" onClick={handleStartRanking}>
                            Start Ranking <span>â–¶</span>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    );
}

/* ------------------------------------------------------------------------------------
   RANKING SCREEN /list/:listId/rank
------------------------------------------------------------------------------------ */
function RankingScreen() {
    const { listId } = useParams();
    const history = useHistory();

    const [items, setItems] = useState([]);
    const [rankedItems, setRankedItems] = useState([]);

    useEffect(() => {
        async function load() {
            const res = await fetch(`/api/list/${listId}`);
            const data = await res.json();
            setItems(data.items || []);
        }
        load();
    }, [listId]);

    /* Dragging logic â€” unchanged */
    const handleDragStartAvailable = (e,item) => {
        e.dataTransfer.setData("drag","avail");
        e.dataTransfer.setData("item",item);
    };
    const handleDragStartRanked = (e,index) => {
        e.dataTransfer.setData("drag","ranked");
        e.dataTransfer.setData("src",String(index));
    };
    const handleDropRanked = (e,targetIndex=null) => {
        e.preventDefault();
        const type = e.dataTransfer.getData("drag");
        if (type==="avail") {
            const item = e.dataTransfer.getData("item");
            if (!rankedItems.includes(item)) {
                const next=[...rankedItems];
                if (targetIndex===null) next.push(item);
                else next.splice(targetIndex,0,item);
                setRankedItems(next);
                setItems(items.filter(i=>i!==item));
            }
        } else {
            const src = parseInt(e.dataTransfer.getData("src"),10);
            if (isNaN(src)) return;
            const updated=[...rankedItems];
            const [moved]=updated.splice(src,1);
            const dest = targetIndex===null ? updated.length : targetIndex;
            updated.splice(dest,0,moved);
            setRankedItems(updated);
        }
    };

    /* SUBMIT RANKING */
    const handleSubmitRanking = async () => {
        try {
            const res = await fetch(`/api/list/${listId}/submit`, {
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({ ranked: rankedItems })
            });
            const data = await res.json();
            console.log("Submitted:", data);
            history.push(`/list/${listId}/results`);
        } catch (err) {
            console.error("submit error:", err);
        }
    };

    return (
        <div className="app-shell">
            <div className="app-shell-inner">

                <div className="app-header">
                    <div className="app-title">Ranking</div>
                    <div className="app-pill">#{listId}</div>
                </div>

                <div className="container">

                    {/* LEFT: Available */}
                    <div className="panel">
                        <div className="panel-header">
                            <div>
                                <div className="panel-title">Available</div>
                            </div>
                        </div>

                        <div className="list-body">
                            {items.map(item => (
                                <div className="item"
                                     key={item}
                                     draggable
                                     onDragStart={(e)=>handleDragStartAvailable(e,item)}>
                                    {item}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* RIGHT: Ranked */}
                    <div className="panel">
                        <div className="panel-header">
                            <div className="panel-title">Ranking</div>
                        </div>

                        <div className="ranked-list" onDragOver={e=>e.preventDefault()}
                             onDrop={(e)=>handleDropRanked(e,null)}>
                            {rankedItems.map((item,index)=>(
                                <div className="ranked-item"
                                     key={item+"-"+index}
                                     draggable
                                     onDragStart={(e)=>handleDragStartRanked(e,index)}
                                     onDragOver={(e)=>e.preventDefault()}
                                     onDrop={(e)=>handleDropRanked(e,index)}>
                                    <span>
                                        <span className="ranked-number">#{index+1}</span>
                                        {item}
                                    </span>
                                </div>
                            ))}
                        </div>

                        <button className="primary-button" onClick={handleSubmitRanking}>
                            Submit Ranking âœ”
                        </button>
                    </div>

                </div>
            </div>
        </div>
    );
}

/* ------------------------------------------------------------------------------------
   RESULTS SCREEN   /list/:listId/results
------------------------------------------------------------------------------------ */
function ResultsScreen() {
    const { listId } = useParams();
    const [results, setResults] = useState(null);

    useEffect(() => {
        async function load() {
            const res = await fetch(`/api/list/${listId}/results`);
            const data = await res.json();
            setResults(data);
        }
        load();
    }, [listId]);

    if (!results) return (
        <div className="app-shell">
            <div className="app-shell-inner"><div>Loading results...</div></div>
        </div>
    );

    return (
        <div className="app-shell">
            <div className="app-shell-inner">
                <div className="app-header">
                    <div className="app-title">Results</div>
                    <div className="app-pill">#{listId}</div>
                </div>

                <div className="create-heading">Consensus Ranking</div>

                {results.final.map((r,i)=>(
                    <div className="ranked-item" key={r.item}>
                        <span>
                            <span className="ranked-number">#{i+1}</span>
                            {r.item}
                        </span>
                        <span style="color:#94a3b8">Score: {r.score}</span>
                    </div>
                ))}

            </div>
        </div>
    );
}

/* ------------------------------------------------------------------------------------
   APP ROUTER
------------------------------------------------------------------------------------ */
function App() {
    const [listItems, setListItems] = useState([]);

    return (
        <BrowserRouter basename="/listr">
            <Switch>

                <Route exact path="/" component={HomeScreen} />

                <Route
                    path="/create"
                    render={() => <CreateListScreen setListItems={setListItems} />}
                />

                <Route
                    path="/list/:listId/rank"
                    render={() => <RankingScreen />}
                />

                <Route
                    path="/list/:listId/results"
                    render={() => <ResultsScreen />}
                />

                <Route
                    path="/rank"
                    render={() => <RankingScreen initialItems={listItems} />}
                />

            </Switch>
        </BrowserRouter>
    );
}

console.log("ðŸ”¥ SCRIPT LOADED â€” Top of file executed");
ReactDOM.render(<App />, document.getElementById("root"));

</script>
</body>
</html>
